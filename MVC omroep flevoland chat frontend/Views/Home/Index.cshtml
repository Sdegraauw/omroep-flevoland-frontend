@{
    ViewData["Title"] = "Home Chat";
}

@model API

<div>
    <flowise-fullchatbot></flowise-fullchatbot>
</div>
<head>
    <title>File Searcher</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        .status-icon {
            display: none;
            font-size: 24px;
        }

            .status-icon.success {
                color: green;
            }

            .status-icon.error {
                color: red;
            }
    </style>
</head>
<body>
    <form id="fileUploadForm" method="post" enctype="multipart/form-data">
        <input type="file" id="fileUpload" name="fileUpload" accept=".pdf" />
        <input type="button" id="uploadButton" value="Upload" />
        <span id="uploadSuccess" class="status-icon success">&#10003;</span>
        <span id="uploadError" class="status-icon error">&#10007;</span>
    </form>
    <script type="module">
        import Chatbot from 'https://cdn.jsdelivr.net/npm/flowise-embed/dist/web.js'
        let formData = new FormData();
        formData.append("files", document.getElementById('fileUpload').files[0])
        formData.append("baseUrl", "http://10.42.0.1:11434")
        formData.append("modelName", "mxbai-embed-large")
        formData.append("temperature", 1)

        Chatbot.initFull({
            chatflowid: '@Model.FlowID',
            apiHost: '@Model.BaseUrl',
            chatflowConfig: {
                sessionId: "123",
                returnSourceDocuments: true
            },
            theme: {
                button: {
                    backgroundColor: '#bf2133',
                },
                chatWindow: {
                    welcomeMessage: 'hallo, waar kan ik je mee helpen?',
                    backgroundColor: 'floralWhite',
                    height: (screen.height / 1.5),
                    width: (screen.width / 1.5),
                    fontSize: 16,
                    poweredByTextColor: '#303235',
                    botMessage: {
                        backgroundColor: 'floralwhite',
                        textColor: '#303235',
                        showAvatar: false
                    },
                    userMessage: {
                        backgroundColor: '#f9dbdb',
                        textColor: '#303235',
                        showAvatar: false,
                    },
                    textInput: {
                        placeholder: 'Type your question',
                        backgroundColor: '#ffffff',
                        textColor: '#303235',
                        sendButtonColor: '#bf2133',
                    }
                }
            }
        })
    </script>
    <script>
        document.getElementById('uploadButton').addEventListener('click', function () {

            let formData = new FormData();
            formData.append("files", document.getElementById('fileUpload').files[0])
            formData.append("sessionId", "123")

            async function uploadFormData(formData) {
                const response = await fetch(
                    'http://localhost:3000/api/v1/vector/upsert/' + '@Model.FlowID',
                    {
                        method: "POST",
                        body: formData,
                        sessionId: "123"
                    }
                );
                const result = await response.json();
                return result;
            }

            async function query(data) {
                const response = await fetch(
                    "http://localhost:3000/api/v1/prediction/" + '@Model.FlowID',
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(data)
                    }
                );
                const result = await response.json();
                return result;
            }

            uploadFormData(formData).then(() => query({ "question": "Kan je een beknopte samenvating geven van het document?" })).then((response) => {
                console.log(response);
            });

            // uploadFormData(formData).then((response) => {
            //     console.log(response);
            // });

        });
    </script>
</body>

